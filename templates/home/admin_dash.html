{% load static %}
<!doctype html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administration • Tableau de bord</title>

  <!-- ⚠️ Dev only: remplace par build Tailwind en prod -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine (facultatif, mais utile pour petits toggles) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Font Awesome (si tu l'utilises déjà) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            be: {
              sky: { 50:"#F2FAFF",100:"#DEF3FF",200:"#BEE8FF",300:"#8AD7FF",400:"#4DBFFF",500:"#1EA7FF",600:"#0C87D6",700:"#0B6FAE",800:"#0C5C8E",900:"#0A466B" },
              sun: { 50:"#FFFBEA",100:"#FFF3BF",200:"#FFE58A",300:"#FFD14D",400:"#FFBD1F",500:"#F7A600",600:"#D48300",700:"#AD6400",800:"#8A4E00",900:"#6A3B00" },
              ink: { 50:"#F7FAFC",100:"#EEF2F7",200:"#D7DEE9",300:"#B5C0D4",400:"#7E8AA6",500:"#5B6783",600:"#3F4A63",700:"#2B3449",800:"#1E2536",900:"#121827" }
            }
          },
          boxShadow: {
            soft: "0 10px 30px rgba(12,92,142,.12)",
            lift: "0 12px 40px rgba(18,24,39,.14)"
          },
          borderRadius: { '2.5xl': '1.25rem' }
        }
      }
    }
  </script>

  <style>
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none; scrollbar-width:none}
    [x-cloak]{display:none!important}
  </style>
</head>

<body class="h-full bg-gradient-to-br from-be-sky-50 via-white to-be-sun-50 text-be-ink-900">
<div class="min-h-full" x-data="adminDash()">

  <!-- TOPBAR -->
  <header class="sticky top-0 z-40">
    <div class="mx-auto max-w-[1600px] px-3 sm:px-6 py-3">
      <div class="flex items-center justify-between gap-3 rounded-2.5xl border border-be-sky-100/70 bg-white/80 backdrop-blur-xl shadow-soft px-3 sm:px-4 py-2.5">

        <div class="flex items-center gap-3 min-w-0">
          <a href="{% url 'home' %}" class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-2xl bg-white border border-be-ink-100/70 flex items-center justify-center overflow-hidden">
              <img src="{% static 'img/logo_img.png' %}" alt="Logo" class="w-8 h-8 object-contain">
            </div>
            <div class="leading-tight min-w-0">
              <div class="font-extrabold tracking-tight truncate">best-épargne</div>
              <div class="text-[11px] text-be-ink-500 -mt-0.5 truncate">Administration</div>
            </div>
          </a>
        </div>

        <div class="hidden lg:flex flex-1 max-w-xl">
          <div class="relative w-full">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-be-ink-400 text-sm"></i>
            <input x-model.debounce.300ms="q"
                   placeholder="Rechercher un utilisateur, un cours, une transaction…"
                   class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-be-ink-100/70 bg-white/90
                          focus:outline-none focus:ring-4 focus:ring-be-sky-200/60 text-sm"/>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a href="{% url 'learner_dashboard' %}"
             class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
            <i class="fa-solid fa-arrow-left"></i> Espace apprenant
          </a>

          <div class="flex items-center gap-2 pl-2 pr-3 py-2 rounded-xl border border-be-ink-100/70 bg-white/90">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-be-sun-300 to-be-sun-500 flex items-center justify-center text-be-ink-900 font-extrabold text-sm">
{#              {{ request.user.get_full_name|default:request.user.username|slice:":1"|upper }}#}
            </div>
            <div class="hidden sm:block leading-tight">
              <div class="text-sm font-semibold">{{ request.user.get_full_name }}</div>
              <div class="text-[11px] text-be-ink-500 -mt-0.5">
                {% if request.user.is_superuser %}Super Admin{% elif request.user.is_staff %}Staff{% else %}Admin{% endif %}
              </div>
            </div>
          </div>

          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit"
                    class="w-10 h-10 inline-flex items-center justify-center rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition"
                    title="Déconnexion">
              <i class="fa-solid fa-right-from-bracket"></i>
            </button>
          </form>
        </div>

      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-[1600px] px-3 sm:px-6 pb-10">
    <!-- Hero -->
    <div class="mt-4 grid lg:grid-cols-12 gap-4">
      <section class="lg:col-span-9">
        <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft p-5 sm:p-6">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div class="min-w-0">
              <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">Tableau de bord Admin</h1>
              <p class="mt-1 text-sm text-be-ink-500">
                Pilotage global : utilisateurs, cours, paiements, contenus, support & conformité.
              </p>
            </div>

            <div class="flex items-center gap-2">
              <button @click="refresh()"
                      class="px-3 py-2 rounded-xl bg-be-ink-900 text-white hover:opacity-90 text-sm font-semibold">
                <i class="fa-solid fa-rotate mr-2"></i>Actualiser
              </button>
              <a href="/admin/"
                 class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 text-sm font-semibold">
                <i class="fa-solid fa-shield-halved mr-2"></i>Django Admin
              </a>
            </div>
          </div>

          <!-- KPI cards -->
          <div class="mt-6 grid sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <!-- Users -->
            <div class="rounded-2xl border border-be-ink-100/70 bg-gradient-to-br from-white to-be-sky-50 p-4">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[11px] uppercase tracking-wide text-be-ink-500">Utilisateurs</div>
                  <div class="mt-1 text-2xl font-extrabold">
                    {{ stats.users_total|default:"—" }}
                  </div>
                  <div class="mt-1 text-xs text-be-ink-500">
                    +{{ stats.users_new_7d|default:"—" }} sur 7 jours
                  </div>
                </div>
                <div class="w-11 h-11 rounded-2xl bg-be-sky-100 text-be-sky-700 flex items-center justify-center">
                  <i class="fa-solid fa-users"></i>
                </div>
              </div>
            </div>

            <!-- Enrollments -->
            <div class="rounded-2xl border border-be-ink-100/70 bg-gradient-to-br from-white to-be-sun-50 p-4">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[11px] uppercase tracking-wide text-be-ink-500">Inscriptions</div>
                  <div class="mt-1 text-2xl font-extrabold">
                    {{ stats.enrollments_total|default:"—" }}
                  </div>
                  <div class="mt-1 text-xs text-be-ink-500">
                    {{ stats.enrollments_active|default:"—" }} actives
                  </div>
                </div>
                <div class="w-11 h-11 rounded-2xl bg-be-sun-100 text-be-sun-700 flex items-center justify-center">
                  <i class="fa-solid fa-book-open"></i>
                </div>
              </div>
            </div>

            <!-- Revenue -->
            <div class="rounded-2xl border border-be-ink-100/70 bg-gradient-to-br from-white to-emerald-50 p-4">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[11px] uppercase tracking-wide text-be-ink-500">Revenus</div>
                  <div class="mt-1 text-2xl font-extrabold">
                    {{ stats.revenue_month|default:"—" }}
                  </div>
                  <div class="mt-1 text-xs text-be-ink-500">
                    Mois en cours
                  </div>
                </div>
                <div class="w-11 h-11 rounded-2xl bg-emerald-100 text-emerald-700 flex items-center justify-center">
                  <i class="fa-solid fa-sack-dollar"></i>
                </div>
              </div>
            </div>

            <!-- Support -->
            <div class="rounded-2xl border border-be-ink-100/70 bg-gradient-to-br from-white to-rose-50 p-4">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[11px] uppercase tracking-wide text-be-ink-500">Support</div>
                  <div class="mt-1 text-2xl font-extrabold">
                    {{ stats.tickets_open|default:"—" }}
                  </div>
                  <div class="mt-1 text-xs text-be-ink-500">
                    Tickets ouverts
                  </div>
                </div>
                <div class="w-11 h-11 rounded-2xl bg-rose-100 text-rose-700 flex items-center justify-center">
                  <i class="fa-solid fa-headset"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick actions -->
          <div class="mt-6 grid md:grid-cols-2 xl:grid-cols-4 gap-3">
            <a href="{#% url 'admin_course_create' %#}"
               class="rounded-2xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-be-sky-100 text-be-sky-700 flex items-center justify-center">
                  <i class="fa-solid fa-circle-plus"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-extrabold">Créer un cours</div>
                  <div class="text-xs text-be-ink-500">Programme, prix, publication</div>
                </div>
              </div>
            </a>

            <a href="{#% url 'admin_users' %#}"
               class="rounded-2xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-be-sun-100 text-be-sun-700 flex items-center justify-center">
                  <i class="fa-solid fa-user-gear"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-extrabold">Gérer utilisateurs</div>
                  <div class="text-xs text-be-ink-500">Rôles, blocage, validation</div>
                </div>
              </div>
            </a>

            <a href="{#% url 'admin_payments' %#}"
               class="rounded-2xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-emerald-100 text-emerald-700 flex items-center justify-center">
                  <i class="fa-solid fa-receipt"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-extrabold">Paiements</div>
                  <div class="text-xs text-be-ink-500">Transactions & remboursements</div>
                </div>
              </div>
            </a>

            <a href="{#% url 'admin_settings' %#}"
               class="rounded-2xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-be-ink-100 text-be-ink-700 flex items-center justify-center">
                  <i class="fa-solid fa-sliders"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-extrabold">Paramètres</div>
                  <div class="text-xs text-be-ink-500">SEO, emails, paiement, sécurité</div>
                </div>
              </div>
            </a>
          </div>
        </div>

        <!-- Recent tables -->
        <div class="mt-4 grid xl:grid-cols-2 gap-4">

          <!-- Latest enrollments -->
          <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft overflow-hidden">
            <div class="p-4 border-b border-be-ink-100/70 flex items-center justify-between">
              <div>
                <div class="font-extrabold">Dernières inscriptions</div>
                <div class="text-xs text-be-ink-500">Les plus récentes activités apprenants</div>
              </div>
              <a href="{#% url 'admin_enrollments' %#}" class="text-sm font-semibold text-be-sky-700 hover:text-be-sky-800">
                Voir tout <i class="fa-solid fa-arrow-right text-xs ml-1"></i>
              </a>
            </div>

            <div class="overflow-auto no-scrollbar">
              <table class="min-w-full text-sm">
                <thead class="bg-be-ink-50/60">
                  <tr class="text-left text-xs text-be-ink-500">
                    <th class="px-4 py-3 font-semibold">Apprenant</th>
                    <th class="px-4 py-3 font-semibold">Cours</th>
                    <th class="px-4 py-3 font-semibold">Date</th>
                    <th class="px-4 py-3 font-semibold">Statut</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-be-ink-100/70">
                  {% for e in latest_enrollments %}
                  <tr class="hover:bg-be-ink-50/40">
                    <td class="px-4 py-3">
                      <div class="font-semibold">{{ e.user_name|default:e.user }}</div>
                      <div class="text-xs text-be-ink-500">{{ e.user_email|default:"" }}</div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="font-semibold">{{ e.course_title|default:e.course }}</div>
                      <div class="text-xs text-be-ink-500">{{ e.course_id|default:"" }}</div>
                    </td>
                    <td class="px-4 py-3 text-be-ink-600">{{ e.created_at|date:"d/m/Y H:i"|default:"—" }}</td>
                    <td class="px-4 py-3">
                      {% if e.is_active %}
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Active</span>
                      {% else %}
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-be-ink-100 text-be-ink-700">Inactive</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="px-4 py-6 text-center text-be-ink-500">Aucune inscription récente.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Latest payments -->
          <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft overflow-hidden">
            <div class="p-4 border-b border-be-ink-100/70 flex items-center justify-between">
              <div>
                <div class="font-extrabold">Derniers paiements</div>
                <div class="text-xs text-be-ink-500">Transactions & confirmations</div>
              </div>
              <a href="{#% url 'admin_payments' %#}" class="text-sm font-semibold text-be-sky-700 hover:text-be-sky-800">
                Voir tout <i class="fa-solid fa-arrow-right text-xs ml-1"></i>
              </a>
            </div>

            <div class="overflow-auto no-scrollbar">
              <table class="min-w-full text-sm">
                <thead class="bg-be-ink-50/60">
                  <tr class="text-left text-xs text-be-ink-500">
                    <th class="px-4 py-3 font-semibold">Référence</th>
                    <th class="px-4 py-3 font-semibold">Utilisateur</th>
                    <th class="px-4 py-3 font-semibold">Montant</th>
                    <th class="px-4 py-3 font-semibold">Statut</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-be-ink-100/70">
                  {% for p in latest_payments %}
                  <tr class="hover:bg-be-ink-50/40">
                    <td class="px-4 py-3">
                      <div class="font-semibold">{{ p.reference|default:p.id }}</div>
                      <div class="text-xs text-be-ink-500">{{ p.provider|default:"" }}</div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="font-semibold">{{ p.user_name|default:p.user }}</div>
                      <div class="text-xs text-be-ink-500">{{ p.user_email|default:"" }}</div>
                    </td>
                    <td class="px-4 py-3 font-extrabold">
                      {{ p.amount|default:"—" }} {{ p.currency|default:"XOF" }}
                    </td>
                    <td class="px-4 py-3">
                      {% if p.status == "PAID" %}
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Payé</span>
                      {% elif p.status == "PENDING" %}
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-be-sun-100 text-be-sun-800">En attente</span>
                      {% else %}
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-700">Échec</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="px-4 py-6 text-center text-be-ink-500">Aucune transaction récente.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Content / Courses management -->
        <div class="mt-4 rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft overflow-hidden">
          <div class="p-4 border-b border-be-ink-100/70 flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold">Gestion des cours</div>
              <div class="text-xs text-be-ink-500">Publication, qualité, sections/leçons, médias</div>
            </div>
            <div class="flex items-center gap-2">
              <a href="{#% url 'admin_courses' %#}"
                 class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
                Liste des cours
              </a>
              <a href="{#% url 'admin_course_create' %#}"
                 class="px-3 py-2 rounded-xl bg-be-sky-600 text-white hover:bg-be-sky-700 transition text-sm font-semibold">
                <i class="fa-solid fa-plus mr-2"></i>Nouveau
              </a>
            </div>
          </div>

          <div class="p-4 grid md:grid-cols-3 gap-3">
            <div class="rounded-2xl border border-be-ink-100/70 bg-white p-4">
              <div class="text-xs text-be-ink-500">Cours publiés</div>
              <div class="mt-1 text-2xl font-extrabold">{{ stats.courses_published|default:"—" }}</div>
              <div class="mt-2 text-xs text-be-ink-500">Visibles sur le catalogue</div>
            </div>
            <div class="rounded-2xl border border-be-ink-100/70 bg-white p-4">
              <div class="text-xs text-be-ink-500">Brouillons</div>
              <div class="mt-1 text-2xl font-extrabold">{{ stats.courses_draft|default:"—" }}</div>
              <div class="mt-2 text-xs text-be-ink-500">À compléter avant publication</div>
            </div>
            <div class="rounded-2xl border border-be-ink-100/70 bg-white p-4">
              <div class="text-xs text-be-ink-500">Signalements</div>
              <div class="mt-1 text-2xl font-extrabold">{{ stats.content_flags|default:"—" }}</div>
              <div class="mt-2 text-xs text-be-ink-500">Contenu à modérer / vérifier</div>
            </div>
          </div>
        </div>

      </section>

      <!-- Right rail -->
      <aside class="lg:col-span-3 space-y-4">
        <!-- System health -->
        <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft p-4">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Santé système</div>
            <span class="text-[11px] px-2 py-1 rounded-full border border-be-ink-100/70 bg-white text-be-ink-600">
              {{ system.status|default:"OK" }}
            </span>
          </div>

          <div class="mt-3 space-y-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-be-ink-500">API</span>
              <span class="font-semibold">{{ system.api_latency_ms|default:"—" }} ms</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-be-ink-500">Jobs</span>
              <span class="font-semibold">{{ system.jobs_queue|default:"—" }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-be-ink-500">Stockage</span>
              <span class="font-semibold">{{ system.storage|default:"—" }}</span>
            </div>
          </div>

          <div class="mt-3 text-xs text-be-ink-500">
            (Optionnel) Tu peux alimenter ces valeurs via une vue “health”.
          </div>
        </div>

        <!-- Admin shortcuts -->
        <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft p-4">
          <div class="font-extrabold">Raccourcis</div>
          <div class="mt-3 grid gap-2">
            <a href="{#% url 'admin_reports' %#}"
               class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
              <i class="fa-solid fa-chart-column mr-2 text-be-sky-700"></i>Rapports & analytics
            </a>
            <a href="{#% url 'admin_coupons' %#}"
               class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
              <i class="fa-solid fa-ticket mr-2 text-be-sun-700"></i>Coupons / promos
            </a>
            <a href="{#% url 'admin_instructors' %#}"
               class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
              <i class="fa-solid fa-chalkboard-user mr-2 text-be-ink-700"></i>Formateurs
            </a>
            <a href="{#% url 'admin_support' %#}"
               class="px-3 py-2 rounded-xl border border-be-ink-100/70 bg-white hover:bg-be-ink-50 transition text-sm font-semibold">
              <i class="fa-solid fa-life-ring mr-2 text-rose-700"></i>Support
            </a>
          </div>
        </div>

        <!-- Recent activity -->
        <div class="rounded-2.5xl border border-be-ink-100/70 bg-white/80 shadow-soft overflow-hidden">
          <div class="p-4 border-b border-be-ink-100/70 flex items-center justify-between">
            <div>
              <div class="font-extrabold">Activité récente</div>
              <div class="text-xs text-be-ink-500">Audit / événements</div>
            </div>
            <a href="{#% url 'admin_audit' %#}" class="text-sm font-semibold text-be-sky-700 hover:text-be-sky-800">
              Audit <i class="fa-solid fa-arrow-right text-xs ml-1"></i>
            </a>
          </div>

          <div class="p-3 space-y-2">
            {% for a in recent_activity %}
              <div class="rounded-2xl border border-be-ink-100/70 bg-white p-3">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="text-sm font-semibold truncate">{{ a.title|default:"Événement" }}</div>
                    <div class="text-xs text-be-ink-500 mt-1 line-clamp-2">
                      {{ a.message|default:"—" }}
                    </div>
                  </div>
                  <div class="text-[11px] text-be-ink-500 shrink-0">
                    {{ a.created_at|date:"d/m H:i"|default:"—" }}
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="text-sm text-be-ink-500 p-3">Aucune activité récente.</div>
            {% endfor %}
          </div>
        </div>

      </aside>
    </div>

    <!-- Footer -->
    <div class="mt-6 text-center text-xs text-be-ink-500">
      © {% now "Y" %} best-épargne • Administration
    </div>
  </main>

</div>

<script>
function adminDash(){
  return {
    q: "",
    refresh(){
      // simple: recharge page (si tu veux, remplace par fetch APIs)
      window.location.reload();
    }
  }
}
</script>
</body>
</html>