{% load static %}
<!doctype html>
<html lang="fr" class="h-full"
      x-data="appShell()"
      x-init="initShell()"
      :class="theme==='dark' ? 'dark' : ''">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %}best-épargne — Apprenant{% endblock %}</title>

  <!-- Tailwind + Alpine (CDN, ok en dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            be: {
              sky: { 50:"#F2FAFF",100:"#DEF3FF",200:"#BEE8FF",300:"#8AD7FF",400:"#4DBFFF",500:"#1EA7FF",600:"#0C87D6",700:"#0B6FAE",800:"#0C5C8E",900:"#0A466B" },
              sun: { 50:"#FFFBEA",100:"#FFF3BF",200:"#FFE58A",300:"#FFD14D",400:"#FFBD1F",500:"#F7A600",600:"#D48300",700:"#AD6400",800:"#8A4E00",900:"#6A3B00" },
              ink: { 50:"#F7FAFC",100:"#EEF2F7",200:"#D7DEE9",300:"#B5C0D4",400:"#7E8AA6",500:"#5B6783",600:"#3F4A63",700:"#2B3449",800:"#1E2536",900:"#121827" }
            }
          },
          boxShadow: {
            soft: "0 10px 30px rgba(12,92,142,.12)",
            ring: "0 0 0 6px rgba(30,167,255,.12)",
            lift: "0 12px 40px rgba(18,24,39,.14)"
          },
          borderRadius: { '2.5xl': '1.25rem' }
        }
      }
    }
  </script>

  <style>
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none; scrollbar-width:none}
    [x-cloak]{display:none !important}
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="h-full bg-gradient-to-br from-be-sky-50 via-white to-be-sun-50
             dark:from-be-ink-900 dark:via-be-ink-900 dark:to-black
             text-be-ink-900 dark:text-be-ink-50">

<!-- Layout wrapper -->
<div class="min-h-full"
     :class="sidebar.collapsed ? 'be-sidebar-collapsed' : 'be-sidebar-expanded'">

  <!-- MOBILE overlay drawer -->
  <div x-cloak x-show="sidebar.mobileOpen" x-transition.opacity class="fixed inset-0 z-50 lg:hidden">
    <div class="absolute inset-0 bg-black/50" @click="sidebar.mobileOpen=false"></div>

    <div x-transition:enter="transition transform duration-200"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition transform duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="-translate-x-full"
         class="absolute left-0 top-0 h-full w-[86%] max-w-[320px]">

      {% block sidebar_mobile %}
        {% include "partials/learner_side.html" with mode="mobile" %}
      {% endblock %}
    </div>
  </div>

  <!-- Topbar -->
  <header class="sticky top-0 z-40">
    <div class="mx-auto max-w-[1600px] px-3 sm:px-6 py-3">
      <div class="flex items-center justify-between gap-3 rounded-2.5xl border border-be-sky-100/70
                  dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur-xl shadow-soft px-3 sm:px-4 py-2.5">

        <!-- Left: menu + brand -->
        <div class="flex items-center gap-2 min-w-0">
          <!-- Mobile open -->
          <button class="lg:hidden w-10 h-10 inline-flex items-center justify-center rounded-xl
                         border border-be-ink-100/70 dark:border-white/10
                         hover:bg-be-ink-50/60 dark:hover:bg-white/10 transition"
                  @click="sidebar.mobileOpen=true" aria-label="Ouvrir le menu">
            <img src="{% static 'img/logo_img.png' %}" alt="Logo" class="w-7 h-7 object-contain">
          </button>

          <!-- Desktop collapse -->
          <button class="hidden lg:inline-flex w-10 h-10 items-center justify-center rounded-xl
                         border border-be-ink-100/70 dark:border-white/10
                         hover:bg-be-ink-50/60 dark:hover:bg-white/10 transition"
                  @click="toggleCollapsed()" aria-label="Réduire/étendre le menu">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
              <path d="M8 6h13M8 12h13M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3.5 7.5l2-1.5v12l-2-1.5" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Brand (pas de <a> imbriqué) -->
          <a href="{% url 'learner_dashboard' %}" class="flex items-center gap-3 group min-w-0">
            <div class="w-24 h-12 rounded-xl overflow-hidden flex items-center justify-center">
              <img src="{% static 'img/logo-2.png' %}" alt="Logo" class="w-24 h-10 object-contain">
            </div>

            <div class="leading-tight min-w-0">
              <div class="font-semibold tracking-tight truncate">
                best-épargne
              </div>
              <div class="text-[11px] text-be-ink-500 dark:text-white/60 -mt-0.5 truncate">
                {% block topbar_subtitle %}Espace Apprenant{% endblock %}
              </div>
            </div>
          </a>
        </div>

        <!-- Search slot -->
        <div class="hidden lg:flex flex-1 max-w-xl">
          {% block topbar_search %}
          <div class="relative w-full" x-data="topbarSearch()">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-be-ink-400 dark:text-white/50">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>

            <!-- ✅ IMPORTANT: x-model assignable (plus de ternaire) -->
            <input
              x-model.debounce.300ms="q"
              @input="sync()"
              placeholder="Rechercher un cours…"
              class="w-full pl-10 pr-10 py-2.5 rounded-xl border border-be-ink-100/70 dark:border-white/10
                     bg-white/80 dark:bg-white/5 focus:outline-none focus:ring-4 focus:ring-be-sky-200/60 text-sm"/>

            <!-- Clear -->
            <button type="button"
                    x-show="q && q.length"
                    @click="clear()"
                    class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg
                           inline-flex items-center justify-center
                           hover:bg-be-ink-50/70 dark:hover:bg-white/10 transition"
                    aria-label="Effacer">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>

            <!-- Tiny loading indicator (optionnel) -->
            <div x-show="loading"
                 class="absolute -bottom-5 left-0 text-[11px] text-be-ink-400 dark:text-white/50">
              Recherche…
            </div>
          </div>
          {% endblock %}
        </div>

        <!-- Right actions -->
        <div class="flex items-center gap-2 shrink-0">
          {% block topbar_actions %}{% endblock %}

          <button class="w-10 h-10 inline-flex items-center justify-center rounded-xl
                         border border-be-ink-100/70 dark:border-white/10
                         hover:bg-be-ink-50/60 dark:hover:bg-white/10 transition"
                  @click="toggleTheme()" aria-label="Basculer thème">
            <template x-if="theme==='light'">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </template>
            <template x-if="theme==='dark'">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                <path d="M21 12.8A8.5 8.5 0 1 1 11.2 3a6.5 6.5 0 0 0 9.8 9.8Z"
                      stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </template>
          </button>

          {% block topbar_user %}
          <div class="flex items-center gap-2 pl-2 pr-3 py-2 rounded-xl
                      border border-be-ink-100/70 dark:border-white/10
                      bg-white/80 dark:bg-white/5">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-be-sun-300 to-be-sun-500
                        flex items-center justify-center text-be-ink-900 font-semibold text-sm"
                 x-text="($store.learner?.me?.initials) ? $store.learner.me.initials : 'A'"></div>

            <div class="hidden sm:block leading-tight">
              <div class="text-sm font-semibold"
                   x-text="($store.learner?.me) ? ($store.learner.me.full_name || $store.learner.me.email || 'Apprenant') : 'Apprenant'"></div>
              <div class="text-[11px] text-be-ink-500 dark:text-white/60 -mt-0.5">Apprenant</div>
            </div>
          </div>
          {% endblock %}
        </div>

      </div>
    </div>
  </header>

  <!-- Main layout -->
  <div class="mx-auto max-w-[1600px] px-3 sm:px-6 pb-10">
    <div class="mt-4 grid lg:grid-cols-12 gap-4">

      <aside class="hidden lg:block lg:col-span-3 xl:col-span-2">
        <div class="sticky top-[92px]">
          {% block sidebar %}
            {% include "partials/learner_side.html" with mode="desktop" %}
          {% endblock %}
        </div>
      </aside>

      <main class="lg:col-span-9 xl:col-span-10">
        {% block content %}{% endblock %}
      </main>

    </div>
  </div>

</div><!-- /layout wrapper -->

<!-- ============== Alpine Stores (ROBUST) ============== -->
<script>
document.addEventListener("alpine:init", () => {
  // Store "learner" toujours présent => pas de crash
  if (!Alpine.store("learner")) {
    Alpine.store("learner", {
      filters: { q: "" },
      me: null,

      // Flags optionnels pour UX
      isLoadingEnrollments: false,

      // Méthode safe (peut être remplacée dans pages)
      async loadEnrollments() {
        // Par défaut ne fait rien => évite erreurs si pas implémenté sur une page
        return;
      }
    });
  } else {
    const s = Alpine.store("learner");
    s.filters = s.filters || {};
    if (typeof s.filters.q !== "string") s.filters.q = "";
  }
});
</script>

<!-- ============== App shell ============== -->
<script>
function appShell(){
  return {
    theme: "light",
    sidebar: { collapsed: false, mobileOpen: false },

    initShell(){
      const savedTheme = localStorage.getItem("be_theme");
      this.theme = savedTheme || (
        window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light"
      );

      const savedCollapsed = localStorage.getItem("be_sidebar_collapsed");
      this.sidebar.collapsed = savedCollapsed === "1";

      window.__beShell = this;

      // Évènement global utile pour tes partials JS
      window.dispatchEvent(new CustomEvent("be:sidebar", {
        detail: { collapsed: this.sidebar.collapsed }
      }));
    },

    toggleTheme(){
      this.theme = (this.theme === "dark") ? "light" : "dark";
      localStorage.setItem("be_theme", this.theme);
    },

    toggleCollapsed(){
      this.sidebar.collapsed = !this.sidebar.collapsed;
      localStorage.setItem("be_sidebar_collapsed", this.sidebar.collapsed ? "1" : "0");
      window.dispatchEvent(new CustomEvent("be:sidebar", {
        detail: { collapsed: this.sidebar.collapsed }
      }));
    }
  }
}
</script>

<!-- ============== Topbar search bridge (FIX x-model) ============== -->
<script>
function topbarSearch(){
  return {
    q: "",
    loading: false,
    _t: null,

    init(){
      // init depuis store si présent
      this.q = (Alpine.store("learner")?.filters?.q) || "";
    },

    sync(){
      const store = Alpine.store("learner");
      if (!store) return;

      // push q -> store.filters.q
      store.filters.q = this.q;

      // debounce manuel pour éviter spam
      clearTimeout(this._t);
      this.loading = true;
      this._t = setTimeout(async () => {
        try{
          if (store.loadEnrollments) await store.loadEnrollments();
        } finally {
          this.loading = false;
        }
      }, 250);
    },

    clear(){
      this.q = "";
      this.sync();
    }
  }
}

// auto init des x-data topbarSearch (alpine init hook)
document.addEventListener("alpine:init", () => {
  // rien, juste pour cohérence si besoin
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>