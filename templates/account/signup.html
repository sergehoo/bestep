{% extends "account/_base.html" %}
{% load i18n static %}

{% block head_title %}Inscription — Best-Épargne{% endblock %}

{% block content %}
  <!-- Header premium -->
  <div class="text-center">
    <h1 class="mt-4 text-2xl font-extrabold text-gray-900 tracking-tight">
      Créer un compte
    </h1>
    <p class="text-sm text-gray-500 mt-1">
      Rejoignez Best-Épargne et démarrez votre parcours.
    </p>

    <div class="mt-4 flex flex-wrap items-center justify-center gap-2">
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-sky-50 text-sky-700 text-xs font-semibold border border-sky-100">
        <i class="fas fa-rocket"></i> Démarrage rapide
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-50 text-yellow-800 text-xs font-semibold border border-yellow-100">
        <i class="fas fa-award"></i> Parcours certifiants
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-700 text-xs font-semibold border border-green-100">
        <i class="fas fa-shield-halved"></i> Données protégées
      </span>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="mt-6 rounded-2xl border border-red-100 bg-red-50 p-4">
      <div class="flex gap-3">
        <div class="w-9 h-9 rounded-xl bg-red-100 flex items-center justify-center">
          <i class="fas fa-triangle-exclamation text-red-600"></i>
        </div>
        <div class="text-sm text-red-800">
          <div class="font-semibold">Inscription impossible</div>
          <div class="mt-1">{{ form.non_field_errors }}</div>
        </div>
      </div>
    </div>
  {% endif %}

  <form method="post" action="{% url 'account_signup' %}" class="mt-6 space-y-4" novalidate>
    {% csrf_token %}

    {% for field in form %}
      {% with fname=field.name|default:"" %}
      <div class="space-y-1.5">
        <label class="text-sm font-semibold text-gray-800">{{ field.label }}</label>

        <div class="relative">
          <!-- Left icon -->
          <span class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
            {% if "email" in fname %}
              <i class="fas fa-envelope"></i>
            {% elif "password" in fname %}
              <i class="fas fa-key"></i>
            {% elif "first_name" in fname or "last_name" in fname or "name" in fname %}
              <i class="fas fa-user"></i>
            {% elif "phone" in fname %}
              <i class="fas fa-phone"></i>
            {% else %}
              <i class="fas fa-pen"></i>
            {% endif %}
          </span>

          {{ field }}

          <!-- Right addon -->
          {% if "password" in fname %}
            <button type="button"
                    class="toggle-password absolute inset-y-0 right-0 pr-3 flex items-center justify-center w-10 text-gray-400 hover:text-gray-700 transition"
                    data-target-name="{{ fname }}"
                    aria-label="Afficher/Masquer le mot de passe">
              <i class="fas fa-eye"></i>
            </button>
          {% else %}
            <span class="pointer-events-none absolute inset-y-0 right-0 pr-3 flex items-center text-gray-300">
              <i class="fas fa-circle-check"></i>
            </span>
          {% endif %}
        </div>

        {# ✅ HELP TEXT (petit, discret, propre) #}
        {% if field.help_text %}
          <div class="help-hint">
            <i class="fas fa-circle-info help-hint__icon"></i>
            <div class="help-hint__text">{{ field.help_text|safe }}</div>
          </div>
        {% endif %}

        {% if field.errors %}
          <p class="text-xs text-red-600">{{ field.errors|striptags }}</p>
        {% endif %}

        {% if fname == "password1" %}
          <div class="mt-2 rounded-2xl border border-gray-100 bg-gray-50 p-4">
            <div class="flex gap-3">
              <div class="w-9 h-9 rounded-xl bg-white border border-gray-200 flex items-center justify-center">
                <i class="fas fa-wand-magic-sparkles text-gray-700"></i>
              </div>
              <div class="flex-1">
                <div class="text-xs font-semibold text-gray-800">Mot de passe recommandé</div>
                <div class="mt-1 grid grid-cols-2 gap-2 text-[11px] text-gray-600">
                  <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-300" id="pw-dot-len"></span> 8+ caractères</div>
                  <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-300" id="pw-dot-up"></span> 1 majuscule</div>
                  <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-300" id="pw-dot-num"></span> 1 chiffre</div>
                  <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-300" id="pw-dot-sp"></span> 1 symbole</div>
                </div>
                <div class="mt-3 h-2 rounded-full bg-gray-200 overflow-hidden">
                  <div id="pw-bar" class="h-full w-0 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all"></div>
                </div>
                <div class="mt-1 text-[11px] text-gray-500">
                  Force : <span id="pw-label" class="font-semibold text-gray-700">—</span>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
      {% endwith %}
    {% endfor %}

    <button
      class="group w-full mt-2 py-3 rounded-2xl bg-gradient-to-r from-sky-600 to-sky-500 text-white font-semibold shadow-lg shadow-sky-200 hover:shadow-sky-300 hover:brightness-[1.02] transition flex items-center justify-center gap-2">
      <i class="fas fa-user-check"></i>
      <span>Créer mon compte</span>
      <span class="ml-1 opacity-80 group-hover:translate-x-0.5 transition-transform">→</span>
    </button>

    <p class="text-[11px] text-gray-500 leading-relaxed text-center mt-3">
      En créant un compte, vous acceptez nos
      <a href="#" class="text-sky-600 font-semibold hover:underline">Conditions</a>
      et notre
      <a href="#" class="text-sky-600 font-semibold hover:underline">Politique de confidentialité</a>.
    </p>

    <div class="relative py-2">
      <div class="h-px bg-gray-200"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="px-3 text-xs text-gray-500 bg-white">déjà inscrit ?</span>
      </div>
    </div>

    <a href="{% url 'account_login' %}" class="block w-full py-3 rounded-2xl bg-white border border-gray-200 text-gray-900 font-semibold text-center hover:bg-gray-50 hover:border-gray-300 transition">
      Se connecter
    </a>
  </form>

  <script>
    (function () {
      // Toggle password (icône visible + switch)
      document.querySelectorAll(".toggle-password").forEach((btn) => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-target-name");
          const input = document.querySelector(`input[name="${name}"]`);
          if (!input) return;

          const isPwd = input.type === "password";
          input.type = isPwd ? "text" : "password";
          btn.innerHTML = isPwd ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });
      });

      // Password strength (password1)
      const pwd = document.querySelector('input[name="password1"]');
      if (!pwd) return;

      const dotLen = document.getElementById("pw-dot-len");
      const dotUp  = document.getElementById("pw-dot-up");
      const dotNum = document.getElementById("pw-dot-num");
      const dotSp  = document.getElementById("pw-dot-sp");
      const bar    = document.getElementById("pw-bar");
      const label  = document.getElementById("pw-label");

      function setDot(el, ok) {
        if (!el) return;
        el.classList.toggle("bg-gray-300", !ok);
        el.classList.toggle("bg-green-500", ok);
      }

      function scorePassword(v) {
        let score = 0;
        const hasLen = v.length >= 8;
        const hasUp  = /[A-Z]/.test(v);
        const hasNum = /[0-9]/.test(v);
        const hasSp  = /[^A-Za-z0-9]/.test(v);

        if (hasLen) score += 25;
        if (hasUp)  score += 25;
        if (hasNum) score += 25;
        if (hasSp)  score += 25;

        setDot(dotLen, hasLen);
        setDot(dotUp,  hasUp);
        setDot(dotNum, hasNum);
        setDot(dotSp,  hasSp);

        bar.style.width = score + "%";

        if (score === 0) { label.textContent = "—"; return; }
        if (score <= 25) label.textContent = "Faible";
        else if (score <= 50) label.textContent = "Moyen";
        else if (score <= 75) label.textContent = "Bon";
        else label.textContent = "Excellent";
      }

      pwd.addEventListener("input", () => scorePassword(pwd.value || ""));
      scorePassword(pwd.value || "");
    })();
  </script>

  <style>
    /* Inputs Allauth (sans classes) */
    form input[type="text"],
    form input[type="email"],
    form input[type="password"]{
      width: 100%;
      padding: 0.75rem 2.75rem 0.75rem 2.5rem; /* left icon + right btn */
      border-radius: 1rem;
      border: 1px solid rgb(229 231 235);
      background: rgb(249 250 251);
      outline: none;
      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    form input[type="text"]:focus,
    form input[type="email"]:focus,
    form input[type="password"]:focus{
      background: #fff;
      border-color: rgba(56, 189, 248, .5);
      box-shadow: 0 0 0 4px rgba(56, 189, 248, .18);
    }

    /* ✅ Help text discret + lisible */
    .help-hint{
      margin-top: .35rem;
      display: flex;
      gap: .5rem;
      align-items: flex-start;
      padding: .5rem .75rem;
      border-radius: .9rem;
      border: 1px solid rgb(243 244 246);
      background: rgba(249, 250, 251, .75);
      color: rgb(107 114 128);
      font-size: 8px;
      line-height: 1.35;
    }
    .help-hint__icon{
      margin-top: .05rem;
      color: rgb(148 163 184); /* slate-400 */
      font-size: 12px;
      flex: 0 0 auto;
    }
    .help-hint__text{
      flex: 1 1 auto;
    }

    /* ✅ Icône œil bien visible + zone cliquable */
    .toggle-password{
      border-radius: .85rem;
    }
    .toggle-password:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(56, 189, 248, .18);
    }

    form input[type="checkbox"]{
      width: 1rem;
      height: 1rem;
      border-radius: .35rem;
      border: 1px solid rgb(209 213 219);
      accent-color: #0284c7;
    }
    form input[name]:not([name*="password"]) {
      padding-right: 2.25rem;
    }
  </style>
{% endblock %}